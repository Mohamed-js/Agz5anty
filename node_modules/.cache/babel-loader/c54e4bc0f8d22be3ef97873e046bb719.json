{"ast":null,"code":"import { computeBufferSize } from '../helpers/compute-buffer-size';\nimport { filterBuffer } from '../helpers/filter-buffer';\nimport { interceptConnections } from '../helpers/intercept-connections';\n\nfunction divide(a, b) {\n  var denominator = b[0] * b[0] + b[1] * b[1];\n  return [(a[0] * b[0] + a[1] * b[1]) / denominator, (a[1] * b[0] - a[0] * b[1]) / denominator];\n}\n\nfunction multiply(a, b) {\n  return [a[0] * b[0] - a[1] * b[1], a[0] * b[1] + a[1] * b[0]];\n}\n\nfunction evaluatePolynomial(coefficient, z) {\n  var result = [0, 0];\n\n  for (var i = coefficient.length - 1; i >= 0; i -= 1) {\n    result = multiply(result, z);\n    result[0] += coefficient[i];\n  }\n\n  return result;\n}\n\nexport var createNativeIIRFilterNodeFakerFactory = function createNativeIIRFilterNodeFakerFactory(createInvalidAccessError, createInvalidStateError, createNativeScriptProcessorNode, createNotSupportedError) {\n  return function (nativeContext, baseLatency, _ref) {\n    var channelCount = _ref.channelCount,\n        channelCountMode = _ref.channelCountMode,\n        channelInterpretation = _ref.channelInterpretation,\n        feedback = _ref.feedback,\n        feedforward = _ref.feedforward;\n    var bufferSize = computeBufferSize(baseLatency, nativeContext.sampleRate);\n    var convertedFeedback = feedback instanceof Float64Array ? feedback : new Float64Array(feedback);\n    var convertedFeedforward = feedforward instanceof Float64Array ? feedforward : new Float64Array(feedforward);\n    var feedbackLength = convertedFeedback.length;\n    var feedforwardLength = convertedFeedforward.length;\n    var minLength = Math.min(feedbackLength, feedforwardLength);\n\n    if (feedbackLength === 0 || feedbackLength > 20) {\n      throw createNotSupportedError();\n    }\n\n    if (convertedFeedback[0] === 0) {\n      throw createInvalidStateError();\n    }\n\n    if (feedforwardLength === 0 || feedforwardLength > 20) {\n      throw createNotSupportedError();\n    }\n\n    if (convertedFeedforward[0] === 0) {\n      throw createInvalidStateError();\n    }\n\n    if (convertedFeedback[0] !== 1) {\n      for (var i = 0; i < feedforwardLength; i += 1) {\n        convertedFeedforward[i] /= convertedFeedback[0];\n      }\n\n      for (var _i = 1; _i < feedbackLength; _i += 1) {\n        convertedFeedback[_i] /= convertedFeedback[0];\n      }\n    }\n\n    var scriptProcessorNode = createNativeScriptProcessorNode(nativeContext, bufferSize, channelCount, channelCount);\n    scriptProcessorNode.channelCount = channelCount;\n    scriptProcessorNode.channelCountMode = channelCountMode;\n    scriptProcessorNode.channelInterpretation = channelInterpretation;\n    var bufferLength = 32;\n    var bufferIndexes = [];\n    var xBuffers = [];\n    var yBuffers = [];\n\n    for (var _i2 = 0; _i2 < channelCount; _i2 += 1) {\n      bufferIndexes.push(0);\n      var xBuffer = new Float32Array(bufferLength);\n      var yBuffer = new Float32Array(bufferLength);\n      xBuffer.fill(0);\n      yBuffer.fill(0);\n      xBuffers.push(xBuffer);\n      yBuffers.push(yBuffer);\n    } // tslint:disable-next-line:deprecation\n\n\n    scriptProcessorNode.onaudioprocess = function (event) {\n      var inputBuffer = event.inputBuffer;\n      var outputBuffer = event.outputBuffer;\n      var numberOfChannels = inputBuffer.numberOfChannels;\n\n      for (var _i3 = 0; _i3 < numberOfChannels; _i3 += 1) {\n        var input = inputBuffer.getChannelData(_i3);\n        var output = outputBuffer.getChannelData(_i3);\n        bufferIndexes[_i3] = filterBuffer(convertedFeedback, feedbackLength, convertedFeedforward, feedforwardLength, minLength, xBuffers[_i3], yBuffers[_i3], bufferIndexes[_i3], bufferLength, input, output);\n      }\n    };\n\n    var nyquist = nativeContext.sampleRate / 2;\n    var nativeIIRFilterNodeFaker = {\n      get bufferSize() {\n        return bufferSize;\n      },\n\n      get channelCount() {\n        return scriptProcessorNode.channelCount;\n      },\n\n      set channelCount(value) {\n        scriptProcessorNode.channelCount = value;\n      },\n\n      get channelCountMode() {\n        return scriptProcessorNode.channelCountMode;\n      },\n\n      set channelCountMode(value) {\n        scriptProcessorNode.channelCountMode = value;\n      },\n\n      get channelInterpretation() {\n        return scriptProcessorNode.channelInterpretation;\n      },\n\n      set channelInterpretation(value) {\n        scriptProcessorNode.channelInterpretation = value;\n      },\n\n      get context() {\n        return scriptProcessorNode.context;\n      },\n\n      get inputs() {\n        return [scriptProcessorNode];\n      },\n\n      get numberOfInputs() {\n        return scriptProcessorNode.numberOfInputs;\n      },\n\n      get numberOfOutputs() {\n        return scriptProcessorNode.numberOfOutputs;\n      },\n\n      addEventListener: function addEventListener() {\n        // @todo Dissallow adding an audioprocess listener.\n        return scriptProcessorNode.addEventListener(arguments.length <= 0 ? undefined : arguments[0], arguments.length <= 1 ? undefined : arguments[1], arguments.length <= 2 ? undefined : arguments[2]);\n      },\n      dispatchEvent: function dispatchEvent() {\n        return scriptProcessorNode.dispatchEvent(arguments.length <= 0 ? undefined : arguments[0]);\n      },\n      getFrequencyResponse: function getFrequencyResponse(frequencyHz, magResponse, phaseResponse) {\n        if (frequencyHz.length !== magResponse.length || magResponse.length !== phaseResponse.length) {\n          throw createInvalidAccessError();\n        }\n\n        var length = frequencyHz.length;\n\n        for (var _i4 = 0; _i4 < length; _i4 += 1) {\n          var omega = -Math.PI * (frequencyHz[_i4] / nyquist);\n          var z = [Math.cos(omega), Math.sin(omega)];\n          var numerator = evaluatePolynomial(convertedFeedforward, z);\n          var denominator = evaluatePolynomial(convertedFeedback, z);\n          var response = divide(numerator, denominator);\n          magResponse[_i4] = Math.sqrt(response[0] * response[0] + response[1] * response[1]);\n          phaseResponse[_i4] = Math.atan2(response[1], response[0]);\n        }\n      },\n      removeEventListener: function removeEventListener() {\n        return scriptProcessorNode.removeEventListener(arguments.length <= 0 ? undefined : arguments[0], arguments.length <= 1 ? undefined : arguments[1], arguments.length <= 2 ? undefined : arguments[2]);\n      }\n    };\n    return interceptConnections(nativeIIRFilterNodeFaker, scriptProcessorNode);\n  };\n};","map":null,"metadata":{},"sourceType":"module"}